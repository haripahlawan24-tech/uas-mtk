<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EXAM dev:Salim Ubaidillah</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
/* 1. ANTI-PRINT */
@media print {
    html, body { display: none !important; }
}

/* Nonaktifkan pemilihan teks */
body { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }

/* ===== GLOBAL ===== */
body { margin:0; font-family:'Poppins',sans-serif; background:#e2e8f0; color:#333; position: relative; }
.container { max-width:900px; margin:auto; padding:20px; transition: padding-bottom 0.3s ease-out; position: relative; z-index: 2; } 
.card { background:#fff; padding:25px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition:0.3s; }
.hide { display:none !important; } 
h2,h3{margin-bottom:15px;}
input,textarea,select{border:1px solid #ccc; border-radius:8px; padding:10px; font-size:15px;}

/* EFEK BLUR SAAT PINDAH APP */
body.blurred {
    filter: blur(10px);
    pointer-events: none;
}

/* WATERMARK NAMA SISWA */
#watermarkOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none;
    display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center;
    opacity: 0.06;
    overflow: hidden;
    transform: rotate(-15deg);
}
.watermark-text {
    font-size: 20px; font-weight: bold; color: #000; margin: 50px;
}

/* ===== BUTTONS ===== */
.btn{ padding:10px 20px; border:none; border-radius:10px; cursor:pointer; font-size:15px; margin:5px; transition:0.2s; }
.btn-primary{ background:#4f46e5; color:#fff; }
.btn-primary:hover{ background:#4338ca; }
.btn-secondary{ background:#6b7280; color:#fff; }
.btn-secondary:hover{ background:#4b5563; }
.btn-danger{ background:#ef4444; color:#fff; }
.btn-danger:hover{ background:#b91c1c; }
.btn:active{ transform:scale(0.93); transition:0.1s; }

.number-list { margin-bottom:20px; display:flex; flex-wrap:wrap; gap:5px; transition: all 0.3s ease; }
.num-btn { width:40px; height:40px; display:flex; justify-content:center; align-items:center; background:#d1d5db; border-radius:8px; font-weight:bold; cursor:pointer; border:2px solid transparent; transition:0.2s; }
.num-btn:hover{ background:#9ca3af; }
.num-active { background:#4f46e5; color:#fff; border-color:#4338ca; }
.num-btn.answered { background-color: #10b981; color: white; border-color: #059669; }
.num-btn.unanswered { background-color: #d1d5db; color: #333; border-color: #9ca3af; }

.slide-left{ animation: slideLeft 0.3s ease; }
@keyframes slideLeft{ from{opacity:0; transform:translateX(40px);} to{opacity:1; transform:translateX(0);} }
.slide-right{ animation: slideRight 0.3s ease; }
@keyframes slideRight{ from{opacity:0; transform:translateX(-40px);} to{opacity:1; transform:translateX(0);} }

@media(max-width:600px){ .number-list{justify-content:center;} .btn{width:100%; margin:5px 0;} }

/* === TOAST === */
.toast {
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(6px); background: rgba(0,0,0,0.3); z-index: 50000; 
}
.toast.hidden { display: none; }
.toast-content {
    background: rgba(255,255,255,0.95); padding: 20px 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 25px rgba(0,0,0,0.3);
}
.toast-content button { margin-top: 10px; padding: 8px 15px; border: none; border-radius: 6px; background: #0074ff; color: white; cursor: pointer; }

/* === MODALS (CONFIRM & UNLOCK) === */
.confirm {
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px); background: rgba(0,0,0,0.7); z-index: 10000;
}
.confirm.hidden { display: none; }
.confirm-content {
    background: rgba(255,255,255,0.95); padding: 25px; border-radius: 14px; width: 320px; text-align: center; box-shadow: 0 4px 25px rgba(0,0,0,0.3);
}
.btn-row { margin-top: 15px; display: flex; justify-content: center; gap: 20px; }
.btn-row button { padding: 8px 18px; border: none; border-radius: 6px; cursor: pointer; background: #007bff; color: white; }
.btn-row button:last-child { background: #666; }

/* === KAMERA CSS === */
#cameraContainer {
    display: none; width: 150px; height: 130px; 
    background-color: #000;
    border: 2px solid #333; border-radius: 8px; overflow: hidden; flex-shrink: 0; position: relative;
}
#faceIndicator {
    position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; border-radius: 50%;
    background-color: red; z-index: 10; border: 1px solid white;
}
#webcam { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

#cameraStatus {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: rgba(0,0,0,0.6); color: white; font-size: 10px; text-align: center; padding: 3px 0; font-weight: bold;
}

.header-content { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
@media(max-width: 600px) {
    .header-content { align-items: center; }
    #cameraContainer { width: 110px; height: 95px; }
}

/* CSS KHUSUS ALERT ESSAY */
.essay-alert {
    background-color: #fffbeb;
    color: #92400e;
    border: 1px solid #fcd34d;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    margin-top: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
</style>
</head>
<body>

<div id="toast" class="toast hidden">
    <div class="toast-content">
        <p id="toastMessage"></p>
        <button onclick="closeToast()">OK</button>
    </div>
</div>

<div id="confirmBox" class="confirm hidden">
    <div class="confirm-content">
        <p id="confirmMessage">Apa kamu yakin mengumpulkan?</p>
        <div class="btn-row">
            <button id="confirmYes">Ya</button>
            <button id="confirmNo">Tidak</button>
        </div>
    </div>
</div>

<div id="unlockModal" class="confirm hidden" style="z-index: 20000;">
    <div class="confirm-content">
        <h3 style="color: #d9534f; margin-top:0;">WAJAH TIDAK TERDETEKSI!</h3>
        <p>Sudah 3x peringatan.<br>Panggil Guru Pengawas untuk membuka kunci.</p>
<div style="display: flex; align-items: center; justify-content: center; gap: 12px; max-width: 500px; margin: 20px auto; font-family: sans-serif;">

    <input type="password" id="unlockPassword" placeholder="Password Guru (Face)" 
        style="flex: 1; padding: 12px 16px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.3s;" 
        autocomplete="off">

    <button onclick="checkUnlockPassword()" 
        style="background-color: #10b981; color: white; font-weight: 600; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4); transition: background-color 0.3s;">
        Buka
    </button>

</div>
    </div>
</div>

<div id="fullscreenViolationModal" class="confirm hidden" style="z-index: 30000;">
    <div class="confirm-content">
        <h3 style="color: red; margin-top:0;">PELANGGARAN !!!</h3>
        <p>Kamu melakukan pelanggaran peraturan</p>
        <p style="font-size:13px;">Masukkan Password Guru untuk melanjutkan tanpa mengulang.</p>
        
        <input type="password" id="fsUnlockPassword" placeholder="Password Guru (Fullscreen)" 
            style="margin: 15px 0; width: 80%; padding: 10px; text-align: center; border: 2px solid #red;" autocomplete="off">
        
        <div class="btn-row">
            <button onclick="verifyFullscreenOverride()" style="background: #007bff;">OK</button>
            <button onclick="window.location.reload()" style="background: #666;">Ulang Awal</button>
        </div>
    </div>
</div>

<div id="watermarkOverlay"></div>

<div class="container">
    <div id="startPage" class="card">
        <h2 style="display: flex; align-items: center;">
            <img src="logo.png" alt="Logo" style="width: 50px; height: 50px; margin-right: 10px;" onerror="this.style.display='none'">
            SMP Negeri 3 Babat
        </h2>
        <h3 align="center">Penilaian Sumatif Akhir Semester<br>Tahun Pelajaran 2025/2026</h3>
        
        <div style="background-color: papayawhip; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 80%; max-width: 600px; text-align: justify; margin: 20px auto;">
            <span style="font-weight: bold; color: #0066cc;">Mata Pelajaran:</span> <br><b>MATEMATIKA KELAS 7</b><br>
            <span style="font-weight: bold; color: #0066cc;">Guru Pengampu:</span><br>
            1) Urip, S.Pd.<br>
            2) Salim Ubaidillah, S.Kom.<br>
            <!-- <span style="font-weight: bold; color: #0066cc;">Hari & Tanggal:</span><br>Senin, 1 Desember 2025<br> -->
            <span style="font-weight: bold; color: #0066cc;">Waktu:</span> 90 Menit
        </div>

        <div style="background-color: lightblue; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 80%; max-width: 600px; text-align: justify; margin: 20px auto;">
            <label for="nama">Nama:</label><br>
            <input id="nama" type="text" placeholder="Masukkan nama" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;"><br>
            <div id="nameError" style="color: red; font-size: 12px; display: none;">Nama harus diisi</div><br>
            <label for="kelas">Kelas:</label><br>
            <select id="kelas" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
                <option value="" disabled selected>Pilih Kelas</option>
                <option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="7D">7D</option>
            </select><br>
            <div id="classError" style="color: red; font-size: 12px; display: none;">Kelas harus dipilih</div>
        </div>

        <div style="background-color: lightcyan; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 80%; max-width: 600px; text-align: justify; margin: 20px auto;">
            <h3 style="text-align: center; color: #333;">Peraturan Sumatif</h3>
            <ol style="font-size: 16px; color: #555; line-height: 1.6;">
                <li>Saya berjanji akan mengerjakan sendiri dan tidak mencontek.</li>
                <li><b>Soal Essay dikerjakan di KERTAS.</b></li>
                <li>Saya memahami jika keluar aplikasi maka jawaban tidak bisa tersimpan.</li>
                <li><b>DILARANG KELUAR APLIKASI</b>. Keluar berarti ulang dari awal.</li>
                <li><b>Wajib Mengaktifkan Kamera</b> selama ujian berlangsung.</li>
                <li><b>Ai Tracking:</b> Jika wajah tidak terlihat 3 detik, akan muncul peringatan. 3x Peringatan = TERKUNCI.</li>
            </ol>
            <p style="font-style: italic; color: #888; font-size: 16px; line-height: 1.6;">Pastikan kamu sudah siap sebelum memulai sumatif ini. Berdoalah<br>Good Luck!!!</p>
        </div>

        <div>
            <input type="checkbox" id="agreeCheckbox">
            <label for="agreeCheckbox" style="font-size: 14px; color: #555;">Saya setuju dan memahami aturan tersebut</label>
        </div>
        <div id="agreeError" style="color: red; font-size: 12px; display: none;">Persetujuan harus dicentang</div><br>
        <button id="startButton" class="btn btn-primary" onclick="mulaiKuis()">Mulai</button>
    </div>

    <div id="quizPage" class="hide">
        <div class="card">
            <div class="header-content">
                <div class="text-info">
                    <h2 style="margin-top:0;">PSAS MTK Kelas 7</h2>
                    <p>Waktu tersisa: <span id="timer">90:00</span></p>
                    <p>Total soal: <b><span id="totalSoal"></span></b></p>
                </div>
                <div id="cameraContainer">
                    <div id="faceIndicator"></div>
                    <video id="webcam" autoplay playsinline muted></video>
                    <div id="cameraStatus">Menunggu...</div>
                </div>
            </div>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <button id="toggleNumberList" class="btn btn-secondary" onclick="toggleNumberList()">Tampilkan Nomor Soal</button>
			<div class="number-list hide" id="numberList"></div>
        </div>
        <br>
        <div id="questionCard" class="card"></div>
        <br>
        <div id="navButtons" style="display: flex; justify-content: space-between; gap: 10px;">
            <button class="btn btn-secondary" id="btn-sebelumnya" onclick="nav(-1)" disabled>Sebelumnya</button>
            <button class="btn btn-danger" id="btn-selesai" style="display: none;" onclick="selesaiKuis()">Selesai</button>
            <button class="btn btn-secondary" id="btn-selanjutnya" onclick="nav(1)">Selanjutnya</button>
        </div>
    </div>

    <div id="donePage" class="card hide">
        <h2>Terima kasih</h2>
        <p>Kamu telah mengerjakan dan tidak dapat mengulangi lagi. Silakan kumpulkan kertas lembar jawaban Essay ke pengawas.</p>
        <p>Semoga Sukses!!!</p>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
// URL DATABASE (pastikan sesuai dengan milik Anda)
const firebaseConfig = { databaseURL: "https://uas-mtk-default-rtdb.asia-southeast1.firebasedatabase.app/" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window.saveToFirebase = (p, d) => set(ref(db, p), d);
window.updateFirebase = (p, d) => update(ref(db, p), d);
</script>

<script>
// ================= GLOBAL VARIABLES =================
const mainContainer = document.querySelector('.container');
let curr = 0;
let waktu = 90 * 60; // 90 Menit
let timerInterval;
let DB = { nama: "", kelas: "", jawaban: {}, skor: 0 };
let isFinishedQuiz = false;
let mediaStream = null;

// ================= FACE DETECTION VARIABLES =================
let faceModel = null;
let faceCheckInterval = null;
let faceWarningCount = 0;
let faceMissingSeconds = 0;
const MAX_FACE_WARNINGS = 3;
const faceIndicator = document.getElementById('faceIndicator');
const cameraStatus = document.getElementById('cameraStatus');

// ================= ANTI-SCREENSHOT & CHEAT =================

document.addEventListener('contextmenu', event => event.preventDefault());

document.addEventListener('keyup', (e) => {
    if (e.key === 'PrintScreen') {
        navigator.clipboard.writeText(''); 
        showToast("PERINGATAN: DILARANG MELAKUKAN SCREENSHOT!");
    }
});

window.addEventListener('blur', () => {
    if (!isFinishedQuiz && !document.getElementById('startPage').classList.contains('hide')) {
        document.body.classList.add('blurred');
    }
});

window.addEventListener('focus', () => {
    document.body.classList.remove('blurred');
});


// ================= LOAD FACE MODEL =================
async function loadFaceModel() {
    try {
        faceModel = await blazeface.load();
        console.log("Model Wajah Siap");
        cameraStatus.textContent = "Sistem AI Siap";
    } catch (e) {
        console.error("Gagal memuat model wajah", e);
        showToast("Gagal memuat AI Wajah. Periksa Koneksi Internet.");
    }
}
window.onload = () => { loadFaceModel(); }

// ================= DATA SOAL MATEMATIKA KELAS 7 =================
let pg = [
    { text: "Suatu persamaan memiliki bentuk umum ax+b=0. Yang merupakan contoh dari bentuk umum tersebut adalah...", options: ["2x + 3 = 0", "x<sup>2</sup> + 3 = 0", "2x + 3y = 0", "3x − 4 = 2y"], answer: 0 },
    { text: "Diketahui 3y = 12. Nilai y yang memenuhi persamaan tersebut adalah...", options: ["2", "3", "4", "5"], answer: 2 },
    { text: "Jika 5x = 2x + 9, maka nilai x adalah...", options: ["1", "2", "3", "4"], answer: 2 },
    { text: "Diketahui 4x − 6 = 10. Nilai x adalah...", options: ["1", "3", "4", "5"], answer: 2 },
    { text: "Diketahui 7x + 5 = 19. Nilai x yang benar adalah...", options: ["1", "2", "3", "4"], answer: 1 },
    { text: "Diketahui 5x − 3 = 2x + 9. Nilai x adalah...", options: ["2", "3", "4", "5"], answer: 2 },
    { text: "Diketahui 6x + 4 = 2x + 20. Nilai x adalah...", options: ["3", "4", "5", "6"], answer: 1 },
    { text: "Diketahui 2(x + 3) = 12. Nilai x adalah...", options: ["2", "3", "4", "6"], answer: 1 },
    { text: "Usia Rina 3 tahun lebih tua dari usia Dita. Jika usia Dita adalah x tahun, maka usia Rina adalah...", options: ["x − 3", "x + 3", "3x", "x / 3"], answer: 1 },
    { text: "Harga 5 buku dan 2 pensil adalah Rp34.000. Jika satu buku harganya Rp6.000, maka harga satu pensil adalah...", options: ["Rp2.000", "Rp3.000", "Rp4.000", "Rp5.000"], answer: 0 },
    { text: "Jumlah dua bilangan adalah 25. Jika salah satunya adalah x, maka bilangan lainnya adalah...", options: ["25x", "25 − x", "x − 25", "x + 25"], answer: 1 },
    { text: "Andi menabung di bank setiap bulan sebanyak Rp50.000. Setelah x bulan, jumlah tabungannya dapat dinyatakan dengan...", options: ["50.000 + x", "50.000x", "x − 50.000", "50.000 / x"], answer: 1 },
    { text: "Penyelesaian dari persamaan 4x + 3 = x – 6 adalah...", options: ["-3", "3", "6", "9"], answer: 0 },
    { text: "Jika x merupakan penyelesaian dari 5x – 6 = 3x + 8 maka nilai dari 2x – 3 adalah...", options: ["5", "11", "14", "17"], answer: 1 },
    { text: "Umur ayah 2 kali umur anaknya. Jika selisih umur mereka adalah 20 tahun, maka umur ayah adalah...", options: ["30 tahun", "35 tahun", "40 tahun", "50 tahun"], answer: 2 }
];

let pgk = [
    { 
        text: "Ratih membeli beberapa botol jus dengan harga satuan Rp. 8.500 dengan menggunakan uang Rp. 50.000 dan mendapat kembalian Rp. 7.500 (total dari pecahan 500, 2.000, dan 5.000). Misalkan banyak minuman yang terbeli adalah x. Pernyataan yang benar adalah...", 
        options: ["Kalimat matematika yang tepat adalah 8.750x + 7.500 = 50.000", "Kalimat matematika yang tepat adalah 8.500x + 7.500 = 50.000", "Minuman jus yang terbeli Ratih 6 botol", "Minuman jus yang terbeli Ratih 5 botol"], 
        answer: [1, 3] 
    },
    { 
        text: "Perhatikan tabel berikut <br> <img src='tabelno2.jpg' style='width:100%; max-width:400px; display:block; margin:10px auto; border-radius:8px;'> <br> Pernyataan yang benar berdasarkan tabel diatas adalah ...", 
        options: ["Jika membeli 7 buku, total harganya 105.000", "Harga satu buku adalah 20.000", "Jika uang 60.000, dapat membeli 4 buku", "Grafik hubungan x dan y berbentuk garis lengkung"], 
        answer: [0, 2] 
    },
    { 
        text: "Sebuah mobil berjalan dengan kecepatan tetap sehingga jarak (y) yang ditempuh sebanding dengan waktu tempuh (x). Berikut datanya: <br> <img src='tabelno3.jpg' style='width:100%; max-width:400px; display:block; margin:10px auto; border-radius:8px;'> <br> Berdasarkan persamaan tersebut, pernyataan dibawah ini yang BENAR adalah ...", 
        options: ["Dalam 3 jam mobil menempuh 180 km", "Jika mobil menempuh 300 km, maka waktunya 5 jam", "Kecepatan mobil adalah 60 km/jam", "Jarak bertambah 120 km setiap 2 jam"], 
        answer: [0, 2, 3] 
    },
    { 
        text: "Diketahui persamaan hubungan antara suhu (y) dan waktu (x) adalah: y = 2x + 20. Pernyataan yang benar adalah...", 
        options: ["Jika x = 0, maka suhu 20°C", "Suhu bertambah 2°C setiap 1 menit", "Saat waktu 10 menit suhu 25°C", "Persamaan tersebut grafiknya garis lurus"], 
        answer: [0, 1, 3] 
    },
    { 
        text: "Dari persamaan y = 2x + 20, manakah pasangan nilai tabel berikut yang sesuai?", 
        options: ["x=5 maka y=30", "x=3 maka y=26", "x=4 maka y=22", "x=10 maka y=40"], 
        answer: [0, 1, 3] 
    }
];

let essay = [
    { text: "Tentukanlah nilai x jika 5x = 2x + 9 lengkap dengan prosesnya!" },
    { text: "Jika 3 merupakan penyelesaian dari persamaan px – 5 = 13, maka berapakah nilai p?" },
    { text: "Berapakah nilai a jika -4 merupakan penyelesaian dari 3(x – 1) – 2a = 5?" },
    { text: "Sebuah persegipanjang mempunyai ukuran panjang (2y + 5) cm dan lebar (2y – 1) cm. Jika kelilingnya 68 cm, tentukan: <br>a. Persamaan dalam y <br>b. Panjang dan lebar persegipanjang tersebut" },
    { text: "Pita sepanjang 60 meter akan dibagikan kepada 3 orang anak. Yeni mendapat (x + 4) meter, Neta mendapat (3x – 2) meter, dan Firli mendapat (2x + 4) meter. <br>a. Berapa meter potongan terpanjang pita tersebut? <br>b. Siapa yang mendapat potongan pita terpendek?" }
];

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}
shuffle(pg); shuffle(pgk); //shuffle(essay);
const questions = [...pg.map(q => ({ type: "pg", ...q })), ...pgk.map(q => ({ type: "pgk", ...q })), ...essay.map(q => ({ type: "essay", ...q }))];

// ================= PERHITUNGAN SKOR UPDATE =================
function computeMaxScore() {
    let max = 0;
    for (let i = 0; i < questions.length; i++) { 
        // PG = 2 Poin
        if (questions[i].type === "pg") max += 2; 
        // PGK = 4 Poin
        if (questions[i].type === "pgk") max += 4;
        // Essay tidak dihitung (Manual 50 poin)
    }
    return max;
}

// ================= KAMERA & AI FUNCTIONS =================
async function startCamera() {
    try {
        const videoElement = document.getElementById('webcam');
        const cameraContainer = document.getElementById('cameraContainer');
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoElement.srcObject = mediaStream;
        cameraContainer.style.display = "block";
        startFaceDetection();
        return true;
    } catch (error) { return false; }
}

function stopCamera() {
    stopFaceDetection(); 
    if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; }
    document.getElementById('cameraContainer').style.display = "none";
}

function startFaceDetection() {
    const video = document.getElementById('webcam');
    if (faceCheckInterval) clearInterval(faceCheckInterval);
    faceCheckInterval = setInterval(async () => {
        if (faceModel && video.readyState === 4) {
            const predictions = await faceModel.estimateFaces(video, false);
            if (predictions.length > 0) {
                faceIndicator.style.backgroundColor = '#10b981'; 
                cameraStatus.style.backgroundColor = 'rgba(16, 185, 129, 0.8)';
                cameraStatus.textContent = "Aman: Wajah Terdeteksi";
                faceMissingSeconds = 0;
            } else {
                faceIndicator.style.backgroundColor = 'red';
                faceMissingSeconds++; 
                let timeLeft = 3 - faceMissingSeconds;
                if (timeLeft > 0) {
                    cameraStatus.style.backgroundColor = 'rgba(255, 165, 0, 0.8)'; 
                    cameraStatus.textContent = `Wajah Tidak Terlihat! (${timeLeft})`;
                } else {
                    cameraStatus.style.backgroundColor = 'rgba(239, 68, 68, 0.8)'; 
                    cameraStatus.textContent = "PERINGATAN!";
                    handleNoFace();
                    faceMissingSeconds = 0; 
                }
            }
        }
    }, 1000);
}

function stopFaceDetection() { if (faceCheckInterval) clearInterval(faceCheckInterval); }

function handleNoFace() {
    faceWarningCount++;
    showToast(`PERINGATAN: Wajah tidak terdeteksi! (${faceWarningCount}/${MAX_FACE_WARNINGS})`);
    if (faceWarningCount >= MAX_FACE_WARNINGS) {
        stopFaceDetection();
        document.getElementById('unlockModal').classList.remove('hidden');
    }
}

// PASSWORD UNTUK FACE TRACKING (GURU 123)
window.checkUnlockPassword = function() {
    const passInput = document.getElementById('unlockPassword');
    if (passInput.value === "guru123") {
        faceWarningCount = 0;
        faceMissingSeconds = 0;
        passInput.value = "";
        document.getElementById('unlockModal').classList.add('hidden');
        showToast("Akses dibuka kembali.");
        startFaceDetection();
    } else {
        showToast("Password Salah! Silakan coba lagi.");
        passInput.value = ""; passInput.focus(); 
    }
}

// PASSWORD UNTUK FULLSCREEN (GURU 123)
window.verifyFullscreenOverride = function() {
    const passInput = document.getElementById('fsUnlockPassword');
    if (passInput.value === "guru123") {
        document.getElementById('fullscreenViolationModal').classList.add('hidden');
        passInput.value = "";
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        showToast("Selamat mengerjakan");
    } else {
        showToast("Password Salah");
        passInput.value = ""; passInput.focus();
    }
}

// ================= QUIZ LOGIC =================
async function mulaiKuis() {
    let valid = true;
    document.getElementById("nameError").style.display = "none";
    document.getElementById("classError").style.display = "none";
    document.getElementById("agreeError").style.display = "none";
    if (!nama.value) { document.getElementById("nameError").style.display = "block"; valid = false; }
    if (!kelas.value) { document.getElementById("classError").style.display = "block"; valid = false; }
    if (!document.getElementById("agreeCheckbox").checked) { document.getElementById("agreeError").style.display = "block"; valid = false; }
    if (!valid) return;

    /*if (!faceModel) {
        showToast("Sedang memuat AI Wajah... Tunggu sebentar.");
        await new Promise(r => setTimeout(r, 2000));
        if(!faceModel) { showToast("Gagal memuat AI. Cek koneksi internet."); return; }
    }
    showToast("Meminta akses kamera...");
    const cameraAllowed = await startCamera();
    if (!cameraAllowed) { closeToast(); showToast("Akses kamera WAJIB diizinkan untuk memulai kuis!"); return; }
    closeToast();

    if (document.documentElement.requestFullscreen) { document.documentElement.requestFullscreen(); }
    else if (document.documentElement.mozRequestFullScreen) { document.documentElement.mozRequestFullScreen(); }
    else if (document.documentElement.webkitRequestFullscreen) { document.documentElement.webkitRequestFullscreen(); }
    else if (document.documentElement.msRequestFullscreen) { document.documentElement.msRequestFullscreen(); }
    */
    DB.nama = nama.value; DB.kelas = kelas.value;
    saveToFirebase(`jawaban/${DB.kelas}/${DB.nama}`, DB);

    const watermarkContainer = document.getElementById('watermarkOverlay');
    watermarkContainer.innerHTML = "";
    for(let i=0; i<15; i++) {
        let span = document.createElement("span");
        span.className = "watermark-text";
        span.textContent = `${DB.nama} - ${DB.kelas}`;
        watermarkContainer.appendChild(span);
    }

    document.getElementById("startPage").classList.add("hide");
    document.getElementById("quizPage").classList.remove("hide");
    loadNumberList(); loadQuestion(curr); mulaiTimer();
}

function handleFullscreenChange() {
    const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
    if (!isFullscreen && !isFinishedQuiz) {
        const modal = document.getElementById('fullscreenViolationModal');
        if(modal.classList.contains('hidden')){
            modal.classList.remove('hidden');
        }
    }
}
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('msfullscreenchange', handleFullscreenChange);

function toggleNumberList() {
    const list = document.getElementById("numberList");
    const btn = document.getElementById("toggleNumberList");
    if(list && btn) {
        list.classList.toggle("hide");
        btn.textContent = list.classList.contains("hide") ? "Tampilkan Nomor Soal" : "Sembunyikan Nomor Soal";
    }
}

function loadNumberList() {
    const list = document.getElementById("numberList");
    document.getElementById("totalSoal").textContent = questions.length;
    list.innerHTML = "";
    for (let i = 0; i < questions.length; i++) {
        let btn = document.createElement("div");
        btn.className = "num-btn"; btn.textContent = i + 1;
        if (DB.jawaban[i] !== undefined && DB.jawaban[i] !== null && DB.jawaban[i] !== "" && (Array.isArray(DB.jawaban[i]) ? DB.jawaban[i].length > 0 : true)) {
            btn.classList.add("answered");
        } else { btn.classList.add("unanswered"); }
        btn.onclick = () => { curr = i; loadQuestion(curr); };
        list.appendChild(btn);
    }
    updateActiveNumber();
}
function updateActiveNumber() { document.querySelectorAll(".num-btn").forEach((b, i) => { b.classList.toggle("num-active", i === curr); }); }

function simpanJawaban(no, value) {
    DB.jawaban[no] = value;
	updateFirebase(`jawaban/${DB.kelas}/${DB.nama}/jawaban`, DB.jawaban);
    loadNumberList();
}
function updatePGK(no) {
    const boxes = document.querySelectorAll(`input[name='q${no}']`);
    const selected = [];
    boxes.forEach(b => { if (b.checked) selected.push(Number(b.value)); });
    simpanJawaban(no, selected);
}

function loadQuestion(i) {
    const q = questions[i];
    let html = `<h3>${i + 1}. ${q.text}</h3><br>`;
    if (q.type === "pg") {
        q.options.forEach((o, idx) => { html += `<label style="display:block;margin-bottom:8px;"><input type="radio" name="q${i}" value="${idx}" ${DB.jawaban[i] == idx ? "checked" : ""} onchange="simpanJawaban(${i}, ${idx})"> ${o}</label>`; });
    } else if (q.type === "pgk") {
        q.options.forEach((o, idx) => { const checked = DB.jawaban[i]?.includes(idx) ? "checked" : ""; html += `<label style="display:block;margin-bottom:8px;"><input type="checkbox" name="q${i}" value="${idx}" ${checked} onchange="updatePGK(${i})"> ${o}</label>`; });
    } else if (q.type === "essay") {
        html += `<div class="essay-alert">Jawaban tulis di Kertas yang telah disediakan lengkap dengan proses atau caranya</div>`;
    }
    document.getElementById("questionCard").innerHTML = html;
    updateActiveNumber();
    document.getElementById("btn-selesai").style.display = (curr === questions.length - 1) ? 'inline-block' : 'none';
    document.getElementById("btn-selanjutnya").style.display = (curr === questions.length - 1) ? 'none' : 'inline-block';
    document.getElementById("btn-sebelumnya").style.display = (curr === 0) ? 'none' : 'inline-block';
    document.getElementById("btn-sebelumnya").disabled = (curr === 0);
}

function nav(step) {
    let old = curr; curr += step;
    if (curr < 0) curr = 0; if (curr >= questions.length) curr = questions.length - 1;
    let card = document.getElementById("questionCard");
    if (curr > old) { card.classList.remove("slide-right"); card.classList.add("slide-left"); }
    else { card.classList.remove("slide-left"); card.classList.add("slide-right"); }
    loadQuestion(curr);
    setTimeout(() => { card.classList.remove("slide-left"); card.classList.remove("slide-right"); }, 300);
}

function mulaiTimer() {
    timerInterval = setInterval(() => {
        waktu--;
        let m = Math.floor(waktu / 60); let s = waktu % 60;
        document.getElementById("timer").textContent = `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        if (waktu <= 0) selesaiKuis();
    }, 1000);
}

function selesaiKuis() {
    let allAnswered = true;
    for (let i = 0; i < questions.length; i++) {
        const q = questions[i]; const j = DB.jawaban[i];
        if (q.type === "pg" && (j===undefined||j===null)) allAnswered=false;
        if (q.type === "pgk" && (!Array.isArray(j)||j.length===0)) allAnswered=false;
    }
    if (!allAnswered) { showToast("Pastikan semua soal PG dan Pilihan Ganda Kompleks sudah dijawab."); return; }

    showConfirm((ok) => {
        if (!ok) return;
        isFinishedQuiz = true;
        clearInterval(timerInterval); stopCamera(); 
        let skor = 0;
        for (let i = 0; i < questions.length; i++) {
            const q = questions[i]; const j = DB.jawaban[i];
            // SKOR PG = 2
            if (q.type === "pg" && j == q.answer) skor += 2;
            // SKOR PGK = 4 (UPDATE)
            if (q.type === "pgk" && Array.isArray(j) && j.length === q.answer.length && q.answer.every(x => j.includes(x))) skor += 4;
        }
        // Hitung Persentase (Berdasarkan Skor Otomatis saja yaitu 50)
        const max = computeMaxScore(); 
        const percent = max > 0 ? Math.round((skor / max) * 100) : 0;
        
        updateFirebase(`jawaban/${DB.kelas}/${DB.nama}`, { skor: skor, persen: percent, jawaban: DB.jawaban });
        document.getElementById("quizPage").classList.add("hide");
        document.getElementById("donePage").classList.remove("hide");
        if (document.fullscreenElement) { document.exitFullscreen().catch(err => console.log(err)); }
    });
}

// ================= TOAST & MODALS =================
function showToast(msg) {
    document.getElementById("toastMessage").textContent = msg;
    document.getElementById("toast").classList.remove("hidden");
}
function closeToast() { document.getElementById("toast").classList.add("hidden"); }
function showConfirm(callback) {
    const box = document.getElementById("confirmBox"); box.classList.remove("hidden");
    document.getElementById("confirmYes").onclick = () => { box.classList.add("hidden"); callback(true); };
    document.getElementById("confirmNo").onclick = () => { box.classList.add("hidden"); callback(false); };
}
</script>
</body>

</html>

